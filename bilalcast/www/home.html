<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <title>Bilal Cast</title>
    <meta name="color-scheme" content="light dark" />

    <!-- PWA / iOS -->
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#0b1220" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Bilal Cast" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link
      rel="apple-touch-icon"
      href="/icons/apple-touch-icon-180.png"
      sizes="180x180"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/icons/icon-192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="/icons/icon-512.png"
    />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <style>
      :root {
        --bg: #0b1220;
        --card: #101826;
        --text: #e6edf3;
        --muted: #98a2b3;
        --accent: #16a34a;
        --accent2: #22c55e;
        --border: #1f2937;
        --pad: 16px;
        --r: 16px;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        overflow-x: hidden;
        touch-action: pan-y;
        -webkit-text-size-adjust: 100%;
      }
      body {
        margin: 0;
        font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial,
          sans-serif;
        background: var(--bg);
        color: var(--text);
        -webkit-tap-highlight-color: transparent;
      }
      body.no-scroll {
        position: fixed;
        width: 100%;
        overflow: hidden;
      }

      .container {
        max-width: 760px;
        margin: 0 auto;
        padding: 16px;
        padding-top: calc(16px + constant(safe-area-inset-top));
        padding-top: calc(16px + env(safe-area-inset-top));
        padding-right: calc(16px + constant(safe-area-inset-right));
        padding-right: calc(16px + env(safe-area-inset-right));
        padding-bottom: calc(16px + constant(safe-area-inset-bottom));
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        padding-left: calc(16px + constant(safe-area-inset-left));
        padding-left: calc(16px + env(safe-area-inset-left));
      }
      header {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 0;
      }
      .brand {
        font-weight: 700;
        letter-spacing: 0.2px;
        font-size: 20px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--r);
        padding: var(--pad);
        margin: 14px 0;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .spacer {
        flex: 1;
      }
      .btn {
        appearance: none;
        border: 0;
        border-radius: 14px;
        padding: 14px 18px;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent);
        color: #fff;
        min-height: 48px;
      }
      .btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn.ghost {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .btn.danger {
        background: var(--danger);
        color: #fff;
      }
      .input,
      select,
      textarea {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: #0f172a;
        color: var(--text);
        min-height: 48px;
      }
      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin: 6px 2px;
      }

      .grid {
        display: grid;
        gap: 14px;
      }
      @media (min-width: 760px) {
        .cols-2 {
          grid-template-columns: 1fr 1fr;
        }
      }

      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .warn {
        color: var(--danger);
      }

      .device-list {
        display: grid;
        gap: 10px;
      }
      .device {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: space-between;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #0f172a;
      }

      .pb {
        height: 10px;
        background: #0f172a;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 8px;
      }
      .pb > i {
        display: block;
        height: 100%;
        width: 0;
        background: var(--accent2);
        transition: width 0.2s ease;
      }
      .hr {
        opacity: 0.3;
      }
      .toast {
        position: fixed;
        left: 16px;
        right: 16px;
        bottom: 16px;
        background: #111827;
        color: #fff;
        border: 1px solid #374151;
        padding: 12px;
        border-radius: 14px;
        display: none;
        z-index: 10;
      }

      .range {
        width: 100%;
      }

      /* Modal */
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .modal.show {
        display: flex;
      }
      .backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
      }
      .dialog {
        position: relative;
        max-width: 640px;
        width: calc(100% - 24px);
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        max-height: 85vh;
        overflow: auto;
      }
      .dialog h3 {
        margin: 0 0 8px 0;
        font-size: 18px;
      }
      .dialog p {
        margin: 6px 0 12px 0;
        color: var(--muted);
        font-size: 14px;
      }

      /* iOS install nudge */
      .install-nudge {
        position: fixed;
        left: 16px;
        right: 16px;
        bottom: calc(16px + env(safe-area-inset-bottom));
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        display: none;
        z-index: 40;
        align-items: center;
        gap: 12px;
      }
      .install-nudge .title {
        font-weight: 700;
        margin: 0 0 2px 0;
      }
      .install-nudge .txt {
        color: var(--muted);
        font-size: 12px;
        margin: 0;
      }

      /* tap-to-open cast field */
      #castDeviceDisplay,
      #testDeviceDisplay {
        cursor: pointer;
      }

      /* Chips row under location input */
      .chips-row {
        display: flex;
        gap: 6px;
        flex-wrap: nowrap;
        white-space: nowrap;
        overflow: hidden; /* keep to one row */
        margin-top: 8px;
      }
      .chip {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--border);
      }

      /* Mobile tweaks */
      @media (max-width: 420px) {
        .card {
          padding: 12px;
          margin: 10px 0;
          border-radius: 12px;
        }
        .row {
          gap: 8px;
        }
        .btn {
          padding: 12px 14px;
          min-height: 44px;
          border-radius: 12px;
        }
        .input,
        select,
        textarea {
          padding: 12px;
          min-height: 44px;
          border-radius: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">Bilal Cast</div>
      </header>

      <!-- Settings -->
      <form class="card" id="settingsForm" novalidate>
        <div class="row">
          <strong>Settings</strong>
          <div class="spacer"></div>
          <button type="button" class="btn ghost" id="reloadSettingsBtn">
            <i class="fa fa-refresh"></i>
          </button>
        </div>

        <div class="grid" style="margin-top: 4px">
          <label class="row" for="useCoords" style="gap: 8px; cursor: pointer">
            <input type="checkbox" id="useCoords" />
            <span>Use coordinates (advanced)</span>
          </label>
        </div>

        <!-- Address OR Coordinates -->
        <div id="addressWrap" class="grid" style="margin-top: 8px">
          <div>
            <label for="address">Address</label>
            <input
              class="input"
              id="address"
              type="text"
              inputmode="text"
              enterkeyhint="done"
              autocomplete="street-address"
              placeholder="123 Main St, City, Country"
            />
          </div>
        </div>

        <div
          id="coordsWrap"
          class="grid cols-2"
          style="margin-top: 8px; display: none"
        >
          <div>
            <label for="latitude">Latitude</label>
            <input
              class="input"
              id="latitude"
              inputmode="decimal"
              enterkeyhint="done"
              step="any"
              placeholder="24.7136"
              disabled
            />
          </div>
          <div>
            <label for="longitude">Longitude</label>
            <input
              class="input"
              id="longitude"
              inputmode="decimal"
              enterkeyhint="done"
              step="any"
              placeholder="46.6753"
              disabled
            />
          </div>
        </div>

        <!-- One-row prayer timing chips -->
        <div
          id="locChips"
          class="chips-row"
          aria-live="polite"
          style="display: none"
        ></div>

        <!-- School / Method / LatAdj / Cast Device -->
        <div class="grid cols-2" style="margin-top: 8px">
          <div>
            <label for="school">School</label>
            <select id="school" class="input"></select>
          </div>
          <div>
            <label for="method">Method</label>
            <select id="method" class="input"></select>
          </div>
          <div>
            <label for="latAdj">Latitude Adjustment</label>
            <select id="latAdj" class="input"></select>
          </div>
          <div>
            <label for="castDeviceDisplay">Google Cast Device</label>
            <input
              id="castDeviceDisplay"
              class="input"
              type="text"
              readonly
              role="button"
              aria-controls="castModal"
              aria-haspopup="dialog"
              placeholder="Tap to select a device"
            />
            <div
              id="deviceWarning"
              class="small warn"
              style="display: none; margin-top: 6px"
            ></div>
          </div>
        </div>
        <hr class="hr" />
        <!-- Athan & Reminder grouped into cards -->
        <div class="grid" style="margin-top: 14px">
          <!-- Fajr (stacked) -->
          <div class="row"><strong>Fajr</strong></div>
          <div class="grid" style="margin-top: 8px">
            <div>
              <label for="vol-fajr">Fajr Volume</label>
              <input
                id="vol-fajr"
                class="range"
                type="range"
                min="0"
                max="1"
                step="any"
                value=".70"
                list="vol-options"
              />
              <div class="small" id="out-fajr">70%</div>
            </div>
            <div>
              <label for="file-fajr">Fajr Audio</label>
              <select id="file-fajr" class="input"></select>
            </div>
          </div>
          <hr class="hr" />
          <!-- Other prayers (stacked) -->
          <div class="row"><strong>Other prayers</strong></div>
          <div class="grid" style="margin-top: 8px">
            <div>
              <label for="vol-athan">Athan Volume</label>
              <input
                id="vol-athan"
                class="range"
                type="range"
                min="0"
                max="1"
                step="any"
                value=".70"
                list="vol-options"
              />
              <div class="small" id="out-athan">70%</div>
            </div>
            <div>
              <label for="file-athan">Athan Audio</label>
              <select id="file-athan" class="input"></select>
            </div>
          </div>
          <hr class="hr" />
          <!-- Reminder (own card, applies to all) -->
          <div class="row">
            <strong>Reminder</strong>
            <div class="spacer"></div>
            <span class="small">Applies to all prayers</span>
          </div>
          <div class="grid" style="margin-top: 8px">
            <div>
              <label for="file-rem">Reminder Audio</label>
              <select id="file-rem" class="input"></select>
            </div>
            <div>
              <label for="min-rem">Reminder minutes prior</label>
              <select id="min-rem" class="input"></select>
            </div>
          </div>
        </div>

        <!-- Save -->
        <div class="row" style="margin-top: 14px">
          <button
            type="submit"
            id="saveBtn"
            class="btn"
            style="width: 100%"
            disabled
          >
            Save changes
          </button>
        </div>
      </form>

      <!-- Test audio (bottom card) -->
      <section class="card" id="testCard">
        <div class="row">
          <strong>Test audio</strong>
          <div class="spacer"></div>
          <span class="small">Not saved — for quick testing</span>
        </div>
        <div class="grid" style="margin-top: 8px">
          <div>
            <label for="testDeviceDisplay">Google Cast Device</label>
            <input
              id="testDeviceDisplay"
              class="input"
              type="text"
              readonly
              role="button"
              aria-controls="castModal"
              aria-haspopup="dialog"
              placeholder="Tap to select a device"
            />
            <div
              id="testDeviceWarning"
              class="small warn"
              style="display: none; margin-top: 6px"
            ></div>
          </div>
          <div>
            <label for="file-test">Audio file</label>
            <select id="file-test" class="input"></select>
          </div>
          <div>
            <label for="vol-test">Volume</label>
            <input
              id="vol-test"
              class="range"
              type="range"
              min="0"
              max="1"
              step="any"
              value=".70"
              list="vol-options"
            />
            <div class="small" id="out-test">70%</div>
          </div>
          <div class="row">
            <button id="sendTestBtn" class="btn" style="width: 100%">
              Send test
            </button>
          </div>
        </div>
      </section>

      <!-- Bottom: Disconnect Wi‑Fi -->
      <section class="card">
        <div class="row" style="width: 100%">
          <button id="wifiBtn" class="btn danger" style="width: 100%">
            Disconnect Wi‑Fi
          </button>
        </div>
      </section>
    </div>

    <!-- iOS install nudge -->
    <div
      id="installNudge"
      class="install-nudge"
      role="region"
      aria-label="Install Bilal Cast"
    >
      <div>
        <div class="title">Install Bilal Cast</div>
        <p class="txt">Add to Home Screen for a full‑screen app experience.</p>
      </div>
      <div class="install-actions">
        <button id="installShowBtn" class="btn">Show Instructions</button>
        <button id="installLaterBtn" class="btn ghost">Maybe later</button>
      </div>
    </div>

    <!-- Install modal -->
    <div
      id="installModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="instTitle"
    >
      <div class="backdrop" data-close></div>
      <div class="dialog">
        <div class="row">
          <strong id="instTitle">Install Bilal Cast on your iPhone/iPad</strong>
          <div class="spacer"></div>
          <button id="installCloseBtn" class="btn ghost">Close</button>
        </div>
        <ol class="steps">
          <li class="step">
            <span class="num">1</span>
            <div class="body">
              <div>Tap the <strong>Share</strong> button</div>
              <div class="hint">
                In Safari’s toolbar (bottom on iPhone, top on iPad).
              </div>
            </div>
          </li>
          <li class="step">
            <span class="num">2</span>
            <div class="body">
              <div>Tap <strong>“Add to Home Screen”</strong></div>
            </div>
          </li>
          <li class="step">
            <span class="num">3</span>
            <div class="body">
              <div>Tap <strong>Add</strong> to confirm</div>
            </div>
          </li>
        </ol>
      </div>
    </div>

    <!-- Cast device selector modal -->
    <div
      id="castModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="castTitle"
    >
      <div class="backdrop" data-close></div>
      <div class="dialog">
        <div class="row">
          <strong id="castTitle">Select a Google Cast device</strong>
          <div class="spacer"></div>
          <button id="castCloseBtn" class="btn ghost">Close</button>
        </div>

        <div class="row small" style="margin-top: 6px">
          <span id="mScanMsg">Idle.</span>
          <div class="spacer"></div>
          <span id="mScanPct"></span>
        </div>
        <div id="mScanBar" class="pb" hidden><i id="mScanFill"></i></div>

        <div class="row" style="margin-top: 8px">
          <button id="modalScanBtn" class="btn ghost">Scan for devices</button>
        </div>

        <div id="modalDevices" class="device-list" style="margin-top: 8px">
          <div class="small">
            No devices loaded. Tap <em>Scan for devices</em>.
          </div>
        </div>
      </div>
    </div>

    <!-- Wi‑Fi confirm modal -->
    <div
      id="wifiModal"
      class="modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="wifiTitle"
      aria-describedby="wifiDesc"
    >
      <div class="backdrop" data-close></div>
      <div class="dialog">
        <h3 id="wifiTitle">Disconnect from Wi‑Fi?</h3>
        <p id="wifiDesc">
          This will remove <strong>Bilal Cast</strong> from the current Wi‑Fi
          network and put it into <strong>onboarding mode</strong>. The page may
          stop responding once the device disconnects.
        </p>
        <div class="row">
          <button class="btn ghost" id="wifiCancelBtn">Cancel</button>
          <div class="spacer"></div>
          <button class="btn danger" id="wifiConfirmBtn">Disconnect</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <datalist id="vol-options">
      <option value="0">0</option>
      <option value="0.25">0.25</option>
      <option value="0.5">0.5</option>
      <option value="0.75">0.75</option>
      <option value="1">1</option>
    </datalist>
    <script>
      (() => {
        const API = {
          settings: "/api/settings",
          devices: "/api/devices",
          devicesRefresh: "/api/devices/refresh",
          castTest: "/api/cast/test",
          wifiDisconnect: "/api/wifi/disconnect",
          athans:
            "https://us-central1-project-bilal-338505.cloudfunctions.net/get-athans-list",
        };

        const $ = (id) => document.getElementById(id);
        const J = async (url, opts = {}) => {
          const res = await fetch(url, {
            ...opts,
            headers: {
              "Content-Type": "application/json",
              ...(opts.headers || {}),
            },
          });
          if (!res.ok) throw new Error(String(res.status));
          const ct = res.headers.get("content-type") || "";
          return ct.includes("application/json") ? res.json() : res.text();
        };
        const toast = (msg, ms = 2200) => {
          const t = $("toast");
          t.textContent = msg;
          t.style.display = "block";
          clearTimeout(toast._id);
          toast._id = setTimeout(() => (t.style.display = "none"), ms);
        };
        const isNum = (v) => Number.isFinite(v);
        const title = (s) =>
          String(s || "").replace(/\b\w/g, (m) => m.toUpperCase());

        /* prevent double-tap zoom (lightweight) */
        let lastTouchEnd = 0;
        document.addEventListener(
          "touchend",
          (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) e.preventDefault();
            lastTouchEnd = now;
          },
          { passive: false }
        );

        /* XOR address/coords */
        function setLocationModeUI(useCoords) {
          $("useCoords").checked = !!useCoords;
          const addrWrap = $("addressWrap"),
            coordsWrap = $("coordsWrap");
          const addr = $("address"),
            lat = $("latitude"),
            lon = $("longitude");
          if (useCoords) {
            coordsWrap.style.display = "";
            addrWrap.style.display = "none";
            lat.disabled = false;
            lon.disabled = false;
            addr.disabled = true;
          } else {
            coordsWrap.style.display = "none";
            addrWrap.style.display = "";
            lat.disabled = true;
            lon.disabled = true;
            addr.disabled = false;
          }
        }

        /* selects */
        const SCHOOL = [
          [0, "Shafi', Maliki, Hanbali"],
          [1, "Hanafi"],
        ];
        const LAT_ADJ = [
          [1, "Middle of Night"],
          [2, "One Seventh"],
          [3, "Angle Based (default)"],
        ];
        const setSel = (el, opts, def) => {
          el.innerHTML = opts
            .map(([v, t]) => `<option value="${v}">${t}</option>`)
            .join("");
          el.value = String(def);
        };

        async function loadMethodsFromAlAdhan() {
          try {
            const r = await fetch("https://api.aladhan.com/v1/methods");
            if (!r.ok) throw 0;
            const json = await r.json(),
              data = json?.data;
            const arr = Object.values(data)
              .filter((x) => typeof x?.id === "number" && x?.name)
              .map((x) => ({ id: x.id, name: x.name }))
              .sort((a, b) => a.id - b.id);
            const el = $("method");
            el.innerHTML = arr
              .map((m) => `<option value="${m.id}">${m.name}</option>`)
              .join("");
            el.value = arr.some((m) => m.id === 2)
              ? "2"
              : String(arr[0]?.id || 2);
          } catch {
            const el = $("method");
            el.innerHTML = '<option value="2">ISNA</option>';
            el.value = "2";
          }
        }

        /* Cast device helpers */
        function deviceKey(d) {
          if (!d) return null;
          if (d.host != null && d.port != null) return `${d.host}:${d.port}`;
          if (d.name) return String(d.name);
          return null;
        }
        function formatDevice(d) {
          if (!d) return "";
          const hp = d.host
            ? `${d.host}${Number.isFinite(+d.port) ? ":" + d.port : ""}`
            : "";
          return d.name ? (hp ? `${d.name} • ${hp}` : d.name) : hp;
        }
        function normalizeDevicesResponse(raw) {
          if (Array.isArray(raw))
            return { status: "complete", percent: 100, devices: raw };
          const o = raw || {};
          let p = Number(o.percent);
          if (isNum(p) && p <= 1) p = p * 100;
          return {
            status:
              String(o.status || "").toLowerCase() ||
              (p >= 100 ? "complete" : "scanning"),
            percent: isNum(p) ? Math.max(0, Math.min(100, p)) : null,
            devices: Array.isArray(o.devices)
              ? o.devices
              : Array.isArray(o.device_names)
              ? o.device_names
              : [],
          };
        }

        /* global state */
        const st = {
          settings: null,
          baseline: null,
          castDevice: null,
          testDevice: null,
          modalTarget: "settings", // 'settings' | 'test'
          devMap: new Map(),
          pollCancel: false,
          _scrollY: 0,
          audios: [],
        };

        /* Athan list + minutes options */
        async function loadAthans() {
          try {
            const list = await (await fetch(API.athans)).json();
            st.audios = Array.isArray(list) ? list : [];
          } catch {
            st.audios = [
              { type: "fajr", desc: "Fajr Athan 1", value: "athan_fajr_1.mp3" },
              { type: "athan", desc: "Athan 1", value: "athan_1.mp3" },
              { type: "notification", desc: "Ding", value: "ding.mp3" },
            ];
          }
          const opt = st.audios
            .slice()
            .sort(
              (a, b) =>
                String(a.type).localeCompare(String(b.type)) ||
                String(a.desc || "").localeCompare(String(b.desc || ""))
            )
            .map(
              (a) =>
                `<option value="${a.value}">${title(a.type)} - ${
                  a.desc || a.label || a.value
                }</option>`
            )
            .join("");
          ["file-fajr", "file-athan", "file-rem", "file-test"].forEach((id) => {
            const el = $(id);
            if (el) el.innerHTML = opt;
          });

          // minutes options 0..30 (0 = off)
          const mr = $("min-rem");
          mr.innerHTML = Array.from(
            { length: 31 },
            (_, i) => `<option value="${i}">${i === 0 ? "0 (off)" : i}</option>`
          ).join("");
        }

        /* snapshot helpers */
        function snapshotFromUI() {
          const useCoords = $("useCoords").checked;
          return {
            locationMode: useCoords ? "coords" : "address",
            address: useCoords ? "" : $("address").value.trim(),
            latitude: useCoords ? parseFloat($("latitude").value) : null,
            longitude: useCoords ? parseFloat($("longitude").value) : null,
            school: +$("school").value,
            method: +$("method").value,
            latitudeAdjustmentMethod: +$("latAdj").value || 3,
            cast: st.castDevice
              ? {
                  name: st.castDevice.name || "",
                  host: st.castDevice.host || "",
                  port: Number.isFinite(+st.castDevice.port)
                    ? +st.castDevice.port
                    : null,
                }
              : null,
            // store UI volumes as 0..10 integers
            fajrVol: +$("vol-fajr").value || 0,
            fajrFile: $("file-fajr").value || "",
            athanVol: +$("vol-athan").value || 0,
            athanFile: $("file-athan").value || "",
            remFile: $("file-rem").value || "",
            remMinutes: +$("min-rem").value || 0,
          };
        }

        function snapshotFromSettings(s) {
          const lat = parseFloat(s.latitude ?? s.lat),
            lon = parseFloat(s.longitude ?? s.lon ?? s.lng);
          const has = Number.isFinite(lat) && Number.isFinite(lon);
          const cast =
            s.cast_device && typeof s.cast_device === "object"
              ? s.cast_device
              : null;
          const P = s.prayers || {};
          const other = P.Dhuhr || P.Asr || P.Maghrib || P.Isha || {};
          return {
            locationMode: has ? "coords" : "address",
            address: has ? "" : s.address || "",
            latitude: has ? lat : null,
            longitude: has ? lon : null,
            school: s.school == 0 || s.school == 1 ? +s.school : 0,
            method: Number.isFinite(+s.method ?? NaN)
              ? +s.method
              : Number.isFinite(+s.calcMethod ?? NaN)
              ? +s.calcMethod
              : 2,
            latitudeAdjustmentMethod:
              s.latitudeAdjustmentMethod == null ||
              +s.latitudeAdjustmentMethod === 0
                ? 3
                : +s.latitudeAdjustmentMethod,
            cast: cast
              ? {
                  name: cast.name || "",
                  host: cast.host || "",
                  port: Number.isFinite(+cast.port) ? +cast.port : null,
                }
              : null,
            fajrVol: P.Fajr?.volume,
            fajrFile: P.Fajr?.file || "athan_fajr_1.mp3",
            athanVol: other.volume,
            athanFile: other.file || "athan_1.mp3",
            remFile:
              P.reminder && P.reminder.file ? P.reminder.file : "ding.mp3",
            remMinutes: Number.isFinite(+P.reminder?.minutes)
              ? +P.reminder.minutes
              : 10,
          };
        }

        function deepEq(a, b) {
          if (a === b) return true;
          if (!a || !b || typeof a !== "object" || typeof b !== "object")
            return false;
          const ka = Object.keys(a).sort(),
            kb = Object.keys(b).sort();
          if (ka.length !== kb.length) return false;
          for (let i = 0; i < ka.length; i++) {
            const k = ka[i];
            if (k !== kb[i]) return false;
            if (!deepEq(a[k], b[k])) return false;
          }
          return true;
        }

        function updateSaveEnabled() {
          const snap = snapshotFromUI();
          const hasDevice = !!(snap.cast && (snap.cast.name || snap.cast.host));
          const dirty = st.baseline ? !deepEq(snap, st.baseline) : false;
          $("saveBtn").disabled = !(hasDevice && dirty);
        }

        /* load settings */
        async function loadSettings() {
          $("reloadSettingsBtn").disabled = true;
          try {
            const s = await J(API.settings);
            st.settings = s || {};

            const lat = parseFloat(s.latitude ?? s.lat),
              lon = parseFloat(s.longitude ?? s.lon ?? s.lng);
            const has = Number.isFinite(lat) && Number.isFinite(lon);
            $("address").value = s.address ?? "";
            if (has) {
              $("latitude").value = lat;
              $("longitude").value = lon;
            }
            setLocationModeUI(has);

            $("school").value = String(
              s.school == 0 || s.school == 1 ? s.school : 0
            );
            const m = s.method ?? s.calcMethod;
            if (Number.isFinite(+m)) $("method").value = String(+m);
            const la =
              s.latitudeAdjustmentMethod ?? s.latitude_adjustment_method;
            $("latAdj").value = la == null || +la === 0 ? "3" : String(+la);

            st.castDevice =
              s.cast_device && typeof s.cast_device === "object"
                ? {
                    name: s.cast_device.name,
                    host: s.cast_device.host,
                    port: s.cast_device.port,
                  }
                : null;
            $("castDeviceDisplay").value = formatDevice(st.castDevice) || "";
            $("deviceWarning").style.display = "none";

            // mirror saved device to test device by default
            st.testDevice = st.castDevice ? { ...st.castDevice } : null;
            $("testDeviceDisplay").value = formatDevice(st.testDevice) || "";
            $("testDeviceWarning").style.display = "none";

            const snap = snapshotFromSettings(s);
            $("vol-fajr").value = snap.fajrVol;
            $("out-fajr").textContent = `${(snap.fajrVol * 100).toFixed(0)}%`;
            $("vol-athan").value = snap.athanVol;
            $("out-athan").textContent = `${(snap.athanVol * 100).toFixed(0)}%`;
            $("file-fajr").value = snap.fajrFile;
            $("file-athan").value = snap.athanFile;
            $("file-rem").value = snap.remFile;
            $("min-rem").value = String(snap.remMinutes);

            st.baseline = snap;
            updateSaveEnabled();
          } catch {
            toast("Could not load settings");
          } finally {
            $("reloadSettingsBtn").disabled = false;
          }
        }

        /* Prayer timings chips (AlAdhan) */
        const PRAYER_ORDER = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
        const pad2 = (n) => (n < 10 ? "0" : "") + n;
        const todayStr = () => {
          const d = new Date();
          return `${pad2(d.getDate())}-${pad2(
            d.getMonth() + 1
          )}-${d.getFullYear()}`;
        };
        const debounce = (fn, ms) => {
          let t;
          return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
          };
        };
        function buildTimingsURL({
          useCoords,
          lat,
          lon,
          address,
          method,
          school,
          latAdj,
        }) {
          const date = todayStr();
          const base = "https://api.aladhan.com/v1";
          const q = new URLSearchParams({
            method: String(method),
            school: String(school),
          });
          if (tz) q.set("timezonestring", tz);
          q.set("latitudeAdjustmentMethod", String(latAdj ?? 3));
          if (useCoords) {
            q.set("latitude", String(lat));
            q.set("longitude", String(lon));
            return `${base}/timings/${date}?${q}`;
          } else {
            q.set("address", address);
            return `${base}/timingsByAddress/${date}?${q}`;
          }
        }
        function toHHMM(s) {
          const str = String(s || "");
          // Fallback for "05:02" or "05:02 (EDT)"
          const plain = str.match(/(\d{1,2}):(\d{2})/);
          if (plain) {
            let h_chip = parseInt(plain[1]);
            if (h_chip > 12) {
              h_chip = h_chip - 12;
            }
            return `${h_chip}:${plain[2]}`;
          }
          return str;
        }
        function renderTimingChips(timings) {
          const row = $("locChips");
          row.innerHTML = "";
          if (!timings) {
            row.style.display = "none";
            return;
          }
          PRAYER_ORDER.forEach((p) => {
            const val = toHHMM(timings[p]);
            if (val)
              row.insertAdjacentHTML(
                "beforeend",
                `<span class="chip" style="font-size: 0.8em;">${p[0]} - ${val}</span>`
              );
          });
          row.style.display = "flex";
        }
        async function fetchTimingChips() {
          const useCoords = $("useCoords").checked,
            addr = $("address").value.trim();
          const lat = parseFloat($("latitude").value),
            lon = parseFloat($("longitude").value);
          const school = +$("school").value,
            method = +$("method").value,
            ladj = +$("latAdj").value || 3;

          // basic validation of chosen mode
          if (useCoords) {
            if (
              !(
                Number.isFinite(lat) &&
                Number.isFinite(lon) &&
                lat >= -90 &&
                lat <= 90 &&
                lon >= -180 &&
                lon <= 180
              )
            ) {
              renderTimingChips(null);
              return;
            }
          } else {
            if (!addr) {
              renderTimingChips(null);
              return;
            }
          }

          try {
            const url = buildTimingsURL({
              useCoords,
              lat,
              lon,
              address: addr,
              method,
              school,
              latAdj: ladj,
            });
            const res = await fetch(url);
            if (!res.ok) throw 0;
            const json = await res.json();
            const tim = json?.data?.timings || null;
            const filtered = tim
              ? {
                  Fajr: tim.Fajr,
                  Dhuhr: tim.Dhuhr,
                  Asr: tim.Asr,
                  Maghrib: tim.Maghrib,
                  Isha: tim.Isha,
                }
              : null;
            renderTimingChips(filtered);
          } catch {
            renderTimingChips(null);
          }
        }
        const fetchChipsDebounced = debounce(fetchTimingChips, 600);

        /* Save (now sends volumes as 0.0–1.0 floats) */
        async function saveSettings(e) {
          e.preventDefault();
          const snap = snapshotFromUI();

          const hasDevice = !!(snap.cast && (snap.cast.name || snap.cast.host));
          const dirty = st.baseline ? !deepEq(snap, st.baseline) : true;
          if (!hasDevice) {
            toast("Please select a Cast device");
            return;
          }
          if (!dirty) {
            toast("No changes to save");
            return;
          }

          const btn = $("saveBtn");
          const orig = btn.textContent;
          btn.textContent = "Saving…";
          btn.disabled = true;

          const minutes = +snap.remMinutes; // 0..30 from dropdown, 0 = off
          const P = {
            Fajr: {
              volume: snap.fajrVol,
              file: snap.fajrFile,
            },
            Dhuhr: {
              volume: snap.athanVol,
              file: snap.athanFile,
            },
            Asr: {
              volume: snap.athanVol,
              file: snap.athanFile,
            },
            Maghrib: {
              volume: snap.athanVol,
              file: snap.athanFile,
            },
            Isha: {
              volume: snap.athanVol,
              file: snap.athanFile,
            },
            reminder: {
              volume: snap.athanVol, // reminder follows athan volume
              file: snap.remFile,
              minutes,
            },
          };

          const payload = {
            school: snap.school,
            method: snap.method,
            locationMode: snap.locationMode,
            latitudeAdjustmentMethod: snap.latitudeAdjustmentMethod,
            address: snap.locationMode === "address" ? snap.address : "",
            ...(snap.locationMode === "coords"
              ? { latitude: snap.latitude, longitude: snap.longitude }
              : {}),
            cast_device: snap.cast
              ? {
                  ...(snap.cast.name ? { name: snap.cast.name } : {}),
                  ...(snap.cast.host ? { host: snap.cast.host } : {}),
                  ...(Number.isFinite(snap.cast.port)
                    ? { port: snap.cast.port }
                    : {}),
                }
              : undefined,
            prayers: P,
          };

          try {
            await J(API.settings, {
              method: "PUT",
              body: JSON.stringify(payload),
            });
            st.baseline = snapshotFromUI();
            toast("Settings saved");
            updateSaveEnabled();
          } catch {
            toast("Save failed");
          } finally {
            btn.textContent = orig;
            btn.disabled = false;
          }
        }

        /* Test audio card */
        async function sendTest() {
          const dev = st.testDevice;
          if (!dev || (!dev.name && !dev.host)) {
            toast("Please select a Google Cast device to test");
            $("testDeviceDisplay").focus();
            return;
          }
          const file = $("file-test").value;
          const volFloat = $("vol-test").value;
          if (!file) {
            toast("Please choose an audio file to test");
            return;
          }

          const btn = $("sendTestBtn");
          const orig = btn.textContent;
          btn.textContent = "Testing…";
          btn.disabled = true;
          try {
            const payload = {
              name: dev.name,
              ...(dev.host ? { host: dev.host } : {}),
              ...(isNum(+dev.port) ? { port: +dev.port } : {}),
              file,
              volume: $("vol-test").value, // float 0.0–1.0
            };
            await J(API.castTest, {
              method: "POST",
              body: JSON.stringify(payload),
            });
            toast(`Test sent to ${dev.name || dev.host}`);
          } catch {
            toast("Test failed");
          } finally {
            btn.textContent = orig;
            btn.disabled = false;
          }
        }

        /* Wi‑Fi disconnect */
        const wifiModal = $("wifiModal");
        function showWifiModal() {
          wifiModal.classList.add("show");
        }
        function hideWifiModal() {
          wifiModal.classList.remove("show");
        }
        $("wifiBtn").addEventListener("click", showWifiModal);
        $("wifiCancelBtn").addEventListener("click", hideWifiModal);
        wifiModal.addEventListener("click", (e) => {
          if (e.target.hasAttribute("data-close")) hideWifiModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && wifiModal.classList.contains("show"))
            hideWifiModal();
        });
        $("wifiConfirmBtn").addEventListener("click", async () => {
          const btn = $("wifiConfirmBtn");
          const orig = btn.textContent;
          btn.textContent = "Disconnecting…";
          btn.disabled = true;
          try {
            try {
              await J(API.wifiDisconnect, { method: "POST", body: "{}" });
            } catch {
              const r = await fetch(API.wifiDisconnect);
              if (!r.ok) throw 0;
            }
            hideWifiModal();
            toast(
              "Disconnecting… entering onboarding mode. This page may stop responding."
            );
          } catch {
            toast("Could not trigger Wi‑Fi disconnect");
          } finally {
            btn.textContent = orig;
            btn.disabled = false;
          }
        });

        /* iOS install nudge */
        function isStandalone() {
          return (
            (window.matchMedia &&
              window.matchMedia("(display-mode: standalone)").matches) ||
            ("standalone" in navigator && navigator.standalone)
          );
        }
        function isIOS() {
          return /iphone|ipad|ipod/i.test(navigator.userAgent || "");
        }
        function shouldShowInstallNudge() {
          if (!isIOS() || isStandalone()) return false;
          return true;
        }
        
        function showInstallNudge() {
          const el = $("installNudge");
          if (el) el.style.display = "flex";
        }
        function hideInstallNudge() {
          const el = $("installNudge");
          if (el) el.style.display = "none";
        }
        function showInstallModal() {
          $("installModal").classList.add("show");
        }
        function hideInstallModal() {
          $("installModal").classList.remove("show");
        }
        function wireInstallUI() {
          const n = $("installNudge"),
            m = $("installModal");
          if (!n || !m) return;
          $("installShowBtn").addEventListener("click", () => {
            hideInstallNudge();
            showInstallModal();
          });
          $("installLaterBtn").addEventListener("click", () => {  
            hideInstallNudge();
          });
          $("installCloseBtn").addEventListener("click", () => {
            hideInstallModal();
          });
          m.addEventListener("click", (e) => {
            if (e.target.hasAttribute("data-close")) {
              hideInstallModal();
            }
          });
          if (shouldShowInstallNudge()) setTimeout(showInstallNudge, 1200);
        }

        /* Cast device modal (shared for Settings and Test) + scroll lock */
        const castModal = $("castModal");
        let savedScroll = 0;
        function lockScroll() {
          savedScroll =
            window.scrollY || document.documentElement.scrollTop || 0;
          document.body.classList.add("no-scroll");
          document.body.style.top = `-${savedScroll}px`;
          document.body.style.left = "0";
          document.body.style.right = "0";
        }
        function unlockScroll() {
          document.body.classList.remove("no-scroll");
          document.body.style.top = "";
          document.body.style.left = "";
          document.body.style.right = "";
          window.scrollTo(0, savedScroll || 0);
        }
        function showCastModal(target = "settings") {
          st.modalTarget = target;
          castModal.classList.add("show");
          lockScroll();
          lazyLoadDevices();
        }
        function hideCastModal() {
          st.pollCancel = true;
          castModal.classList.remove("show");
          unlockScroll();
        }

        $("castDeviceDisplay").addEventListener("click", () =>
          showCastModal("settings")
        );
        $("castDeviceDisplay").addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            showCastModal("settings");
          }
        });
        $("testDeviceDisplay").addEventListener("click", () =>
          showCastModal("test")
        );
        $("testDeviceDisplay").addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            showCastModal("test");
          }
        });

        $("castCloseBtn").addEventListener("click", hideCastModal);
        castModal.addEventListener("click", (e) => {
          if (e.target.hasAttribute("data-close")) hideCastModal();
        });

        function setModalScanUI(scanning, percent) {
          $("mScanMsg").textContent = scanning ? "Scanning…" : "Idle.";
          if (isNum(percent)) {
            $("mScanPct").textContent = Math.round(percent) + "%";
            $("mScanBar").hidden = false;
            $("mScanFill").style.width = percent + "%";
          } else {
            $("mScanPct").textContent = "";
            $("mScanBar").hidden = true;
            $("mScanFill").style.width = "0%";
          }
          $("modalScanBtn").disabled = !!scanning;
        }
        function renderModalDeviceList(list) {
          const box = $("modalDevices");
          st.devMap.clear();
          if (!list || !list.length) {
            box.innerHTML = '<div class="small">No devices found yet…</div>';
            updateNetworkWarnings();
            return;
          }
          box.innerHTML = list
            .map((d, i) => {
              const o = typeof d === "string" ? { name: d } : d;
              const k = deviceKey(o) || "i" + i;
              st.devMap.set(k, {
                key: k,
                name: o.name,
                host: o.host,
                port: o.port,
              });
              const hp = o.host
                ? `${o.host}${isNum(+o.port) ? ":" + o.port : ""}`
                : "";
              return `<div class="device">
                      <div><div>${o.name || "Device " + (i + 1)}</div>${
                hp ? `<div class="small">${hp}</div>` : ""
              }</div>
                      <div class="row" style="gap:8px">
                        <button class="btn" data-select="${k}">Select</button>
                      </div>
                    </div>`;
            })
            .join("");
          updateNetworkWarnings();
        }
        async function fetchDevicesOnce() {
          const raw = await J(API.devices);
          return normalizeDevicesResponse(raw);
        }
        async function pollDevicesModal({
          interval = 1000,
          timeout = 60000,
        } = {}) {
          st.pollCancel = false;
          const t0 = Date.now();
          while (!st.pollCancel) {
            const s = await fetchDevicesOnce();
            const scanning = s.status !== "complete" && !(s.percent >= 100);
            setModalScanUI(scanning, s.percent);
            renderModalDeviceList(s.devices || []);
            if (!scanning) return s;
            if (Date.now() - t0 > timeout) {
              toast("Scan timed out");
              return s;
            }
            await new Promise((r) => setTimeout(r, interval));
          }
        }
        async function startScan() {
          try {
            try {
              await J(API.devicesRefresh, { method: "POST", body: "{}" });
            } catch {
              const r = await fetch(API.devicesRefresh);
              if (!r.ok) throw 0;
            }
            await pollDevicesModal();
          } catch {
            toast("Could not start scan");
          }
        }
        async function lazyLoadDevices() {
          try {
            const s = await fetchDevicesOnce();
            setModalScanUI(
              s.status !== "complete" && !(s.percent >= 100),
              s.percent
            );
            renderModalDeviceList(s.devices || []);
            if (s.status !== "complete" && !(s.percent >= 100))
              await pollDevicesModal();
          } catch {
            $("modalDevices").innerHTML =
              '<div class="small">Could not load devices</div>';
            setModalScanUI(false, null);
          }
        }
        $("modalScanBtn").addEventListener("click", startScan);
        $("modalDevices").addEventListener("click", async (e) => {
          const t = e.target;
          const btnTest = t.closest("[data-test]");
          const btnSel = t.closest("[data-select]");
          if (btnTest) {
            const key = btnTest.getAttribute("data-test");
            const dev = st.devMap.get(key);
            if (!dev) return toast("Device not found");
            const original = btnTest.textContent;
            btnTest.textContent = "…";
            btnTest.disabled = true;
            try {
              await J(API.castTest, {
                method: "POST",
                body: JSON.stringify({
                  name: dev.name,
                  ...(dev.host ? { host: dev.host } : {}),
                  ...(isNum(dev.port) ? { port: dev.port } : {}),
                }),
              });
              toast("Test sent to " + dev.name);
            } catch {
              toast("Test failed");
            } finally {
              btnTest.textContent = original;
              btnTest.disabled = false;
            }
          }
          if (btnSel) {
            const key = btnSel.getAttribute("data-select");
            const dev = st.devMap.get(key);
            if (!dev) return toast("Device not found");
            if (st.modalTarget === "test") {
              st.testDevice = {
                name: dev.name,
                ...(dev.host ? { host: dev.host } : {}),
                ...(isNum(dev.port) ? { port: dev.port } : {}),
              };
              $("testDeviceDisplay").value = formatDevice(st.testDevice);
            } else {
              st.castDevice = {
                name: dev.name,
                ...(dev.host ? { host: dev.host } : {}),
                ...(isNum(dev.port) ? { port: dev.port } : {}),
              };
              $("castDeviceDisplay").value = formatDevice(st.castDevice);
              updateSaveEnabled();
            }
            hideCastModal();
            updateNetworkWarnings();
          }
        });

        function updateNetworkWarnings() {
          // settings device warning
          const warnA = $("deviceWarning");
          if (!st.castDevice) {
            warnA.style.display = "none";
            warnA.textContent = "";
          } else {
            const wKey = deviceKey(st.castDevice);
            const existsByKey = wKey && st.devMap.has(wKey);
            const existsByName =
              !existsByKey &&
              st.castDevice.name &&
              [...st.devMap.values()].some(
                (v) => v.name === st.castDevice.name
              );
            if (existsByKey || existsByName) {
              warnA.style.display = "none";
              warnA.textContent = "";
            } else if (st.devMap.size > 0) {
              warnA.textContent = `Selected device "${formatDevice(
                st.castDevice
              )}" was not found on the network in the last scan.`;
              warnA.style.display = "";
            }
          }
          // test device warning
          const warnB = $("testDeviceWarning");
          if (!st.testDevice) {
            warnB.style.display = "none";
            warnB.textContent = "";
          } else {
            const wKey = deviceKey(st.testDevice);
            const existsByKey = wKey && st.devMap.has(wKey);
            const existsByName =
              !existsByKey &&
              st.testDevice.name &&
              [...st.devMap.values()].some(
                (v) => v.name === st.testDevice.name
              );
            if (existsByKey || existsByName) {
              warnB.style.display = "none";
              warnB.textContent = "";
            } else if (st.devMap.size > 0) {
              warnB.textContent = `Selected device "${formatDevice(
                st.testDevice
              )}" was not found on the network in the last scan.`;
              warnB.style.display = "";
            }
          }
        }

        /* init */
        async function init() {
          setSel($("school"), SCHOOL, 0);
          setSel($("latAdj"), LAT_ADJ, 3);

          await loadAthans();
          await loadMethodsFromAlAdhan();
          await loadSettings();

          // initial chips
          fetchTimingChips();

          // settings events
          $("reloadSettingsBtn").addEventListener("click", async () => {
            await loadSettings();
            fetchTimingChips();
          });
          $("settingsForm").addEventListener("submit", saveSettings);

          $("useCoords").addEventListener("change", (e) => {
            setLocationModeUI(e.target.checked);
            fetchChipsDebounced();
            updateSaveEnabled();
          });
          ["address", "latitude", "longitude"].forEach((id) =>
            $(id).addEventListener("input", () => {
              fetchChipsDebounced();
              updateSaveEnabled();
            })
          );
          ["school", "method", "latAdj"].forEach((id) =>
            $(id).addEventListener("change", () => {
              fetchChipsDebounced();
              updateSaveEnabled();
            })
          );
          $("address").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              e.target.blur();
            }
          });

          // audio/volume/minutes events
          $("vol-fajr").addEventListener("input", () => {
            $("out-fajr").textContent = `${($("vol-fajr").value * 100).toFixed(
              0
            )}%`;
            updateSaveEnabled();
          });
          $("vol-athan").addEventListener("input", () => {
            $("out-athan").textContent = `${(
              $("vol-athan").value * 100
            ).toFixed(0)}%`;
            updateSaveEnabled();
          });
          ["file-fajr", "file-athan", "file-rem", "min-rem"].forEach((id) =>
            $(id).addEventListener("change", updateSaveEnabled)
          );

          // test card events
          $("vol-test").addEventListener("input", () => {
            const v = +$("vol-test").value || 0;
            $("out-test").textContent = `${(v * 100).toFixed(0)}%`;
          });
          $("sendTestBtn").addEventListener("click", sendTest);

          // iOS install nudge
          wireInstallUI();
        }
        if (document.readyState !== "loading") init();
        else document.addEventListener("DOMContentLoaded", init);
      })();
    </script>
  </body>
</html>
